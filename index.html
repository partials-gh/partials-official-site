<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partials · HTML Previewer</title>
<link rel="icon" type="image/png" href="images/icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;1,300&family=Fraunces:ital,opsz,wght@0,9..144,200;0,9..144,300;1,9..144,200&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0e10;
    --surface: #16161a;
    --surface2: #1c1c21;
    --border: #2a2a30;
    --border-strong: #3a3a44;
    --text: #e8e6e0;
    --text-muted: #5c5c6a;
    --text-dim: #3c3c48;
    --accent: #4ade80;
    --accent-dim: #1a3325;
    --tag: #232328;
    --mono: 'DM Mono', monospace;
    --serif: 'Fraunces', serif;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    line-height: 1.6;
    overflow: hidden;
  }

  body { -webkit-user-select: none; user-select: none; }
  #editor { -webkit-user-select: text !important; user-select: text !important; }

  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    height: 48px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--text);
    flex-shrink: 0;
  }

  .nav-logo {
    width: 24px; height: 24px;
    border-radius: 5px;
    overflow: hidden;
    background: var(--surface2);
    display: grid;
    place-items: center;
    flex-shrink: 0;
  }

  .nav-logo img {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }

  .nav-logo .fallback {
    font-family: var(--serif);
    font-size: 11px;
    font-weight: 200;
    color: var(--accent);
  }

  .nav-title {
    font-family: var(--serif);
    font-weight: 200;
    font-size: 15px;
    letter-spacing: -0.3px;
  }

  .nav-version {
    font-size: 10px;
    color: var(--text-muted);
    background: var(--tag);
    padding: 2px 7px;
    border-radius: 20px;
    margin-left: 6px;
    letter-spacing: 0.3px;
    border: 1px solid var(--border);
  }

  .nav-divider {
    width: 1px; height: 20px;
    background: var(--border);
    margin: 0 16px;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 2px;
    flex: 1;
  }

  .nav-link {
    text-decoration: none;
    color: var(--text-muted);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    transition: color 0.15s, background 0.15s;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    border: none;
    background: none;
  }

  .nav-link:hover { color: var(--text); background: var(--surface2); }

  .dropdown { position: relative; }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 168px;
    box-shadow: 0 12px 36px rgba(0,0,0,0.6);
    z-index: 200;
  }

  .dropdown-menu.open { display: block; }

  .dropdown-item {
    display: block;
    text-decoration: none;
    color: var(--text-muted);
    padding: 7px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    transition: all 0.12s;
  }

  .dropdown-item:hover { color: var(--text); background: var(--surface2); }

  .dropdown-label {
    font-size: 10px;
    color: var(--text-dim);
    padding: 5px 12px 3px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .github-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    color: var(--text-muted);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    border: 1px solid var(--border);
    transition: all 0.15s;
  }

  .github-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }
  .github-icon { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }

  /* TOOLBAR */
  .toolbar {
    position: fixed;
    top: 48px; left: 0; right: 0;
    z-index: 90;
    height: 42px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 6px;
  }

  .toolbar-label {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-right: 4px;
  }

  .view-toggle {
    display: flex;
    background: var(--bg);
    border-radius: 7px;
    padding: 3px;
    gap: 2px;
    border: 1px solid var(--border);
  }

  .view-btn {
    padding: 4px 12px;
    border-radius: 5px;
    border: none;
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .view-btn.active {
    background: var(--surface2);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.5);
  }

  .toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 8px; }

  .run-btn {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 16px;
    border-radius: 7px;
    border: none;
    background: var(--accent);
    color: #061208;
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    margin-left: auto;
    font-weight: 400;
  }

  .run-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(74,222,128,0.2); }

  .run-icon {
    width: 0; height: 0;
    border-left: 7px solid currentColor;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .clear-btn {
    padding: 5px 12px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .clear-btn:hover { border-color: var(--border-strong); color: var(--text); background: var(--surface2); }

  /* APP */
  .app {
    position: fixed;
    top: 90px; left: 0; right: 0; bottom: 24px;
    display: flex;
  }

  .editor-pane {
    width: 50%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    position: relative;
    min-width: 0;
  }

  .pane-header {
    padding: 9px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    flex-shrink: 0;
  }

  .pane-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); opacity: 0.6; }

  .pane-title {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .line-count { margin-left: auto; font-size: 10px; color: var(--text-dim); }

  .editor-wrap {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .line-numbers {
    padding: 14px 10px 14px 0;
    width: 44px;
    text-align: right;
    color: var(--text-dim);
    font-size: 12px;
    line-height: 1.7;
    border-right: 1px solid var(--border);
    background: var(--bg);
    overflow: hidden;
    flex-shrink: 0;
    user-select: none !important;
    -webkit-user-select: none !important;
  }

  #editor {
    flex: 1;
    padding: 14px 16px;
    border: none;
    outline: none;
    resize: none;
    background: var(--surface);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12.5px;
    line-height: 1.7;
    tab-size: 2;
    white-space: pre;
    overflow-wrap: normal;
    overflow: auto;
    caret-color: var(--accent);
  }

  #editor::placeholder { color: var(--text-dim); }
  #editor:focus { background: #17171c; }

  .preview-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  #preview {
    flex: 1;
    border: none;
    background: white;
  }

  /* RESIZE HANDLE — fixed */
  .resize-handle {
    position: absolute;
    top: 0; right: -4px; bottom: 0;
    width: 8px;
    cursor: col-resize;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .resize-handle::after {
    content: '';
    width: 2px;
    height: 36px;
    border-radius: 2px;
    background: var(--border);
    transition: background 0.15s, height 0.15s;
  }

  .resize-handle:hover::after { background: var(--accent); height: 52px; }
  .resize-dragging .resize-handle::after { background: var(--accent); height: 52px; }

  /* VIEW MODES */
  .app.editor-only .preview-pane { display: none; }
  .app.editor-only .editor-pane { width: 100% !important; }
  .app.preview-only .editor-pane { display: none; }
  .app.preview-only .preview-pane { display: flex; width: 100%; }

  /* STATUS BAR */
  .status-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 24px;
    background: #0a0a0c;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
    z-index: 100;
  }

  .status-item {
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 5px;
    letter-spacing: 0.3px;
  }

  .status-item.live { color: var(--accent); opacity: 0.8; }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
  .status-item.live .status-dot { animation: pulse 2s ease-in-out infinite; }

  /* CONTEXT MENU */
  #ctx-menu, #preview-ctx-menu {
    position: fixed;
    z-index: 9999;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 196px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04) inset;
    display: none;
    pointer-events: all;
  }

  #ctx-menu.visible, #preview-ctx-menu.visible {
    display: block;
    animation: ctxIn 0.12s cubic-bezier(0.2,0,0,1);
  }

  @keyframes ctxIn {
    from { opacity: 0; transform: scale(0.94) translateY(-6px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .ctx-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 7px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.1s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .ctx-item:hover { color: var(--text); background: var(--surface2); }
  .ctx-item.green:hover { color: var(--accent); background: var(--accent-dim); }

  .ctx-icon { width: 14px; height: 14px; opacity: 0.6; flex-shrink: 0; }

  .ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }

  .ctx-kbd {
    margin-left: auto;
    font-size: 10px;
    color: var(--text-dim);
    background: var(--bg);
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid var(--border);
    white-space: nowrap;
  }

  /* FIX OVERLAY */
  .fix-overlay {
    position: absolute;
    inset: 0;
    background: rgba(14,14,16,0.88);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
    gap: 10px;
    flex-direction: column;
    backdrop-filter: blur(6px);
  }

  .fix-overlay.visible { display: flex; }
  .fix-msg { font-size: 12px; color: var(--text-muted); }
  .fix-spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeSlideIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

  nav { animation: fadeSlideIn 0.35s ease both; }
  .toolbar { animation: fadeSlideIn 0.35s ease 0.05s both; }
  .app { animation: fadeSlideIn 0.35s ease 0.1s both; }

  /* ── SHARE BUTTONS IN TOOLBAR ── */
  .share-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .share-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 11px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .share-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }
  .share-btn.primary { background: var(--accent-dim); border-color: rgba(74,222,128,0.25); color: var(--accent); }
  .share-btn.primary:hover { background: rgba(74,222,128,0.15); border-color: rgba(74,222,128,0.4); }

  /* ── MODAL BACKDROP ── */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }

  .modal-backdrop.visible { display: flex; animation: backdropIn 0.2s ease; }

  @keyframes backdropIn { from{opacity:0} to{opacity:1} }

  /* ── MODAL BOX ── */
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    width: 420px;
    max-width: calc(100vw - 32px);
    box-shadow: 0 24px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.04) inset;
    animation: modalIn 0.22s cubic-bezier(0.2,0,0,1);
    overflow: hidden;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.94) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 20px 20px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .modal-title {
    font-family: var(--serif);
    font-weight: 200;
    font-size: 18px;
    letter-spacing: -0.3px;
    color: var(--text);
    line-height: 1.2;
  }

  .modal-close {
    width: 28px; height: 28px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    color: var(--text-muted);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.12s;
    line-height: 1;
  }

  .modal-close:hover { color: var(--text); background: var(--surface2); }

  .modal-body { padding: 16px 20px 20px; }

  .modal-notice {
    font-size: 10px;
    color: var(--text-dim);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 8px 12px;
    margin-bottom: 16px;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .modal-notice-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #facc15;
    flex-shrink: 0;
    animation: pulse 2s ease-in-out infinite;
  }

  /* ── GENERATED CODE DISPLAY ── */
  .code-display {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin-bottom: 14px;
    position: relative;
  }

  .code-display-value {
    font-family: var(--mono);
    font-size: 32px;
    letter-spacing: 10px;
    color: var(--accent);
    font-weight: 300;
    margin-bottom: 6px;
    min-height: 46px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .code-display-sub {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  .code-spinner {
    width: 22px; height: 22px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 0 auto 6px;
  }

  /* ── MODAL ACTIONS ── */
  .modal-actions {
    display: flex;
    gap: 8px;
  }

  .modal-btn {
    flex: 1;
    padding: 9px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .modal-btn:hover { color: var(--text); background: var(--surface2); border-color: var(--border-strong); }

  .modal-btn.accent {
    background: var(--accent);
    border-color: var(--accent);
    color: #061208;
    font-weight: 400;
  }

  .modal-btn.accent:hover { filter: brightness(1.08); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(74,222,128,0.2); }
  .modal-btn.accent:disabled { opacity: 0.4; cursor: not-allowed; transform: none; filter: none; }

  /* ── USE CODE INPUT ROW ── */
  .code-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
  }

  .code-input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 16px;
    letter-spacing: 4px;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.15s;
    text-align: center;
  }

  .code-input:focus { border-color: var(--accent); }
  .code-input.error { border-color: #f87171; animation: shake 0.35s ease; }
  .code-input::placeholder { letter-spacing: 2px; font-size: 12px; color: var(--text-dim); text-transform: none; }

  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-6px)}
    40%{transform:translateX(6px)}
    60%{transform:translateX(-4px)}
    80%{transform:translateX(4px)}
  }

  .code-status {
    font-size: 11px;
    margin-top: 8px;
    min-height: 16px;
    text-align: center;
  }

  .code-status.error { color: #f87171; }
  .code-status.success { color: var(--accent); }
  .code-status.loading { color: var(--text-muted); }

  /* ── SHARED PREVIEW MODAL ── */
  .preview-modal {
    width: min(900px, calc(100vw - 32px));
    height: min(600px, calc(100vh - 80px));
    display: flex;
    flex-direction: column;
  }

  .preview-modal .modal-body {
    flex: 1;
    padding: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-radius: 0 0 14px 14px;
  }

  .shared-iframe {
    flex: 1;
    border: none;
    background: white;
    border-radius: 0 0 14px 14px;
  }

  .preview-modal-bar {
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    flex-shrink: 0;
  }

  .shared-code-badge {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: var(--mono);
  }

  .shared-expiry {
    font-size: 10px;
    color: var(--text-dim);
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  @media (max-width: 640px) {
    .nav-links, .nav-divider { display: none; }
    .editor-pane { width: 100% !important; }
    .preview-pane { display: none; }
    .app.preview-only .editor-pane { display: none; }
    .app.preview-only .preview-pane { display: flex; width: 100%; }
  }
</style>
</head>
<body>

<nav>
  <a href="https://example.com" class="nav-brand">
    <div class="nav-logo" id="nav-logo-wrap">
      <img src="images/icon.png" alt="Partials" id="nav-icon" onerror="document.getElementById('nav-icon').style.display='none';document.getElementById('nav-fallback').style.display='block'">
      <span class="fallback" id="nav-fallback" style="display:none">P</span>
    </div>
    <span class="nav-title">Partials</span>
    <span class="nav-version">v1.2</span>
  </a>

  <div class="nav-divider"></div>

  <div class="nav-links">
    <a href="https://example.com" class="nav-link">About</a>

    <div class="dropdown">
      <button class="nav-link">Tools <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="opacity:0.4"><path d="M1 1l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <div class="dropdown-menu">
        <div class="dropdown-label">Tools</div>
        <a href="https://example.com" class="dropdown-item">Calculator</a>
        <a href="https://example.com" class="dropdown-item">Partials AI</a>
        <a href="https://example.com" class="dropdown-item">Chat Bubble</a>
      </div>
    </div>

    <a href="https://example.com" class="nav-link">Games</a>

    <div class="dropdown">
      <button class="nav-link">Templates <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="opacity:0.4"><path d="M1 1l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <div class="dropdown-menu">
        <div class="dropdown-label">Templates</div>
        <a href="https://example.com" class="dropdown-item">AI Template</a>
        <a href="https://example.com" class="dropdown-item">Calculator Template</a>
        <a href="https://example.com" class="dropdown-item">Portfolio Template</a>
      </div>
    </div>

    <a href="https://example.com" class="nav-link">Portfolio</a>
  </div>

  <div class="nav-right">
    <a href="https://github.com/partials-gh" target="_blank" class="github-btn">
      <svg class="github-icon" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      GitHub
    </a>
  </div>
</nav>

<div class="toolbar">
  <span class="toolbar-label">View</span>
  <div class="view-toggle">
    <button class="view-btn" id="btn-editor" onclick="setView('editor')">Editor</button>
    <button class="view-btn active" id="btn-split" onclick="setView('split')">Split</button>
    <button class="view-btn" id="btn-preview" onclick="setView('preview')">Preview</button>
  </div>
  <div class="toolbar-sep"></div>
  <button class="clear-btn" onclick="clearEditor()">Clear</button>

  <div class="share-group" style="margin-left:auto">
    <button class="share-btn" onclick="openUseCode()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      Use Share Code
    </button>
    <button class="share-btn primary" onclick="openGenerateCode()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
      Generate Share Code
    </button>
    <button class="run-btn" onclick="runPreview()">
      <span class="run-icon"></span>
      Run
    </button>
  </div>
</div>

<div class="app" id="app">
  <div class="editor-pane" id="editor-pane">
    <div class="pane-header">
      <div class="pane-dot"></div>
      <span class="pane-title">HTML Source</span>
      <span class="line-count" id="line-count">2 lines</span>
    </div>
    <div class="editor-wrap">
      <div class="line-numbers" id="line-numbers">1<br>2</div>
      <textarea id="editor" spellcheck="false" placeholder="Write HTML here…"><h1>Welcome</h1>
<p>Start building something.</p></textarea>
    </div>
    <div class="fix-overlay" id="fix-overlay">
      <div class="fix-spinner"></div>
      <span class="fix-msg">Fixing code…</span>
    </div>
    <div class="resize-handle" id="resize-handle"></div>
  </div>

  <div class="preview-pane" id="preview-pane">
    <div class="pane-header">
      <div class="pane-dot" style="background:#a78bfa;opacity:0.6"></div>
      <span class="pane-title">Preview</span>
    </div>
    <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

<div class="status-bar">
  <div class="status-item live">
    <div class="status-dot"></div>
    <span>Live</span>
  </div>
  <div class="status-item"><span>Partials HTML Previewer</span></div>
  <div class="status-item" style="margin-left:auto"><span id="char-count">0 chars</span></div>
  <div class="status-item"><span>est. 2026</span></div>
</div>

<!-- PREVIEW RIGHT-CLICK MENU -->
<div id="preview-ctx-menu" role="menu">
  <button class="ctx-item" onclick="refreshPreview()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
    </svg>
    Refresh Preview
  </button>
  <button class="ctx-item" onclick="sharePreview()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
    </svg>
    <span id="share-label">Share Preview</span>
  </button>
  <div class="ctx-sep"></div>
  <button class="ctx-item" style="color:#f87171" onclick="closePreviewPane()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
    Close Preview
  </button>
</div>

<!-- EDITOR RIGHT-CLICK MENU -->
<div id="ctx-menu" role="menu">
  <button class="ctx-item green" onclick="fixCode()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
    </svg>
    Fix Code
    <span class="ctx-kbd">auto</span>
  </button>
  <button class="ctx-item" onclick="runPreview(); closeCtx()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Run Preview
    <span class="ctx-kbd">ctrl+↵</span>
  </button>
  <div class="ctx-sep"></div>
  <button class="ctx-item" onclick="copyHTML()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
    </svg>
    <span id="copy-label">Copy HTML</span>
    <span class="ctx-kbd">html</span>
  </button>
</div>

<script>
  /* ── BLOCK DEVTOOLS ── */
  document.addEventListener('contextmenu', e => { e.preventDefault(); showCtx(e.clientX, e.clientY); });

  document.addEventListener('keydown', e => {
    if (e.key === 'F12') { e.preventDefault(); return; }
    if (e.ctrlKey && e.shiftKey && ['I','J','C','K'].includes(e.key.toUpperCase())) { e.preventDefault(); return; }
    if (e.ctrlKey && e.key.toLowerCase() === 'u') { e.preventDefault(); return; }
  });

  /* devtools size probe */
  setInterval(() => {
    if (window.outerWidth - window.innerWidth > 200 || window.outerHeight - window.innerHeight > 200) {
      document.body.style.display = 'none';
      document.title = 'close devtools';
    } else {
      if (document.body.style.display === 'none') {
        document.body.style.display = '';
        document.title = 'Partials · HTML Previewer';
      }
    }
  }, 800);

  /* ── DROPDOWN HOVER (JS-based, gap-proof) ── */
  document.querySelectorAll('.dropdown').forEach(dd => {
    let closeTimer;
    const menu = dd.querySelector('.dropdown-menu');

    dd.addEventListener('mouseenter', () => {
      clearTimeout(closeTimer);
      // close all other open menus
      document.querySelectorAll('.dropdown-menu.open').forEach(m => { if (m !== menu) m.classList.remove('open'); });
      menu.classList.add('open');
    });

    dd.addEventListener('mouseleave', () => {
      closeTimer = setTimeout(() => menu.classList.remove('open'), 80);
    });

    menu.addEventListener('mouseenter', () => clearTimeout(closeTimer));
    menu.addEventListener('mouseleave', () => {
      closeTimer = setTimeout(() => menu.classList.remove('open'), 80);
    });
  });

  // Close dropdowns when clicking elsewhere
  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
    }
  });
  const ctxMenu = document.getElementById('ctx-menu');

  function showCtx(x, y) {
    ctxMenu.classList.add('visible');
    const w = 200, h = 140;
    ctxMenu.style.left = Math.min(x, window.innerWidth - w - 8) + 'px';
    ctxMenu.style.top  = Math.min(y, window.innerHeight - h - 8) + 'px';
  }

  function closeCtx() { ctxMenu.classList.remove('visible'); }

  document.addEventListener('mousedown', e => {
    if (!ctxMenu.contains(e.target)) closeCtx();
  });

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeCtx(); });

  /* ── COPY HTML ── */
  function copyHTML() {
    closeCtx();
    navigator.clipboard.writeText(editor.value).then(() => {
      const lbl = document.getElementById('copy-label');
      lbl.textContent = 'Copied!';
      setTimeout(() => { lbl.textContent = 'Copy HTML'; }, 1800);
    }).catch(() => {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = editor.value;
      ta.style.cssText = 'position:fixed;opacity:0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    });
  }

  /* ── FIX CODE ── */
  function fixCode() {
    closeCtx();
    const overlay = document.getElementById('fix-overlay');
    overlay.classList.add('visible');
    setTimeout(() => {
      try {
        const raw = editor.value.trim();
        const parser = new DOMParser();
        const parsed = parser.parseFromString(raw, 'text/html');
        let fixed;
        if (raw.toLowerCase().includes('<!doctype') || raw.toLowerCase().includes('<html')) {
          fixed = '<!DOCTYPE html>\n<html lang="en">\n<head>\n' + parsed.head.innerHTML.trim() + '\n</head>\n<body>\n' + parsed.body.innerHTML.trim() + '\n</body>\n</html>';
        } else {
          fixed = parsed.body.innerHTML.trim();
        }
        editor.value = fixed;
        runPreview();
        updateLineNumbers();
      } catch(err) { /* silent */ }
      overlay.classList.remove('visible');
    }, 900);
  }

  /* ── EDITOR ── */
  const editor     = document.getElementById('editor');
  const preview    = document.getElementById('preview');
  const lineNums   = document.getElementById('line-numbers');
  const lineCount  = document.getElementById('line-count');
  const charCount  = document.getElementById('char-count');
  const app        = document.getElementById('app');

  let debounceTimer;

  /* ── PREVIEW CONTEXT MENU ── */
  const previewCtxMenu = document.getElementById('preview-ctx-menu');

  function showPreviewCtx(x, y) {
    closeCtx();
    previewCtxMenu.classList.add('visible');
    const w = 200, h = 130;
    previewCtxMenu.style.left = Math.min(x, window.innerWidth - w - 8) + 'px';
    previewCtxMenu.style.top  = Math.min(y, window.innerHeight - h - 8) + 'px';
  }

  function closePreviewCtx() { previewCtxMenu.classList.remove('visible'); }

  // Listen for right-click messages posted from inside the iframe
  window.addEventListener('message', e => {
    if (e.data && e.data.type === 'preview-contextmenu') {
      showPreviewCtx(e.data.x, e.data.y);
    }
  });

  // Close preview menu on click outside
  document.addEventListener('mousedown', e => {
    if (!previewCtxMenu.contains(e.target)) closePreviewCtx();
  });

  function refreshPreview() {
    closePreviewCtx();
    runPreview();
  }

  function sharePreview() {
    closePreviewCtx();
    const blob = new Blob([editor.value], { type: 'text/html;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    navigator.clipboard.writeText(url).then(() => {
      const lbl = document.getElementById('share-label');
      lbl.textContent = 'Link Copied!';
      setTimeout(() => { lbl.textContent = 'Share Preview'; URL.revokeObjectURL(url); }, 2500);
    }).catch(() => {
      window.open(url, '_blank');
    });
  }

  function closePreviewPane() {
    closePreviewCtx();
    setView('editor');
  }

  /* Inject right-click blocker into the srcdoc so the iframe can't show native menu */
  const BLOCKER_SCRIPT = `<script>
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.parent.postMessage({ type: 'preview-contextmenu', x: e.clientX, y: e.clientY }, '*');
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12') e.preventDefault();
      if (e.ctrlKey && e.shiftKey && ['I','J','C','K'].includes(e.key.toUpperCase())) e.preventDefault();
    });
  <\/script>`;

  function runPreview() {
    const src = editor.value.trim();
    let injected;
    if (src.toLowerCase().includes('</body>')) {
      injected = src.replace(/<\/body>/i, BLOCKER_SCRIPT + '</body>');
    } else if (src.toLowerCase().includes('<body')) {
      injected = src + BLOCKER_SCRIPT;
    } else {
      // bare HTML snippet — wrap it
      injected = src + BLOCKER_SCRIPT;
    }
    preview.srcdoc = injected;
  }

  editor.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(runPreview, 280);
    updateLineNumbers();
  });

  editor.addEventListener('scroll', () => {
    lineNums.scrollTop = editor.scrollTop;
  });

  function updateLineNumbers() {
    const lines = editor.value.split('\n');
    lineCount.textContent = lines.length + (lines.length === 1 ? ' line' : ' lines');
    charCount.textContent = editor.value.length.toLocaleString() + ' chars';
    lineNums.innerHTML = lines.map((_,i) => i+1).join('<br>');
  }

  editor.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = editor.selectionStart, end = editor.selectionEnd;
      editor.value = editor.value.slice(0, s) + '  ' + editor.value.slice(end);
      editor.selectionStart = editor.selectionEnd = s + 2;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(runPreview, 280);
      updateLineNumbers();
    }
    if (e.ctrlKey && e.key === 'Enter') runPreview();
  });

  /* ── VIEW MODES ── */
  function setView(mode) {
    app.className = 'app';
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    if (mode === 'editor') {
      app.classList.add('editor-only');
      document.getElementById('btn-editor').classList.add('active');
    } else if (mode === 'preview') {
      app.classList.add('preview-only');
      document.getElementById('btn-preview').classList.add('active');
    } else {
      document.getElementById('btn-split').classList.add('active');
    }
  }

  function clearEditor() {
    if (!editor.value.trim()) return;
    if (confirm('Clear all content?')) {
      editor.value = '';
      runPreview();
      updateLineNumbers();
    }
  }

  /* ── RESIZE (FIXED) ──
     Key fix: disable pointer-events on everything except the overlay div
     so the mouse can't "escape" to the iframe or other elements.          */
  const handle     = document.getElementById('resize-handle');
  const editorPane = document.getElementById('editor-pane');
  let isResizing   = false;

  /* Overlay that captures all mouse events during drag */
  const dragOverlay = document.createElement('div');
  dragOverlay.style.cssText = 'position:fixed;inset:0;z-index:9000;cursor:col-resize;display:none';
  document.body.appendChild(dragOverlay);

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    isResizing = true;
    dragOverlay.style.display = 'block';
    handle.classList.add('dragging');
  });

  dragOverlay.addEventListener('mousemove', e => {
    if (!isResizing) return;
    const rect = app.getBoundingClientRect();
    const pct  = ((e.clientX - rect.left) / rect.width) * 100;
    editorPane.style.width = Math.max(20, Math.min(80, pct)) + '%';
  });

  dragOverlay.addEventListener('mouseup', () => {
    isResizing = false;
    dragOverlay.style.display = 'none';
    handle.classList.remove('dragging');
  });

  /* Safety: also catch mouseup on document in case cursor flew past overlay */
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      dragOverlay.style.display = 'none';
      handle.classList.remove('dragging');
    }
  });

  /* ── INIT ── */
  updateLineNumbers();
  runPreview();
</script>

<!-- GENERATE SHARE CODE MODAL -->
<div class="modal-backdrop" id="generate-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Generate Share Code</div>
      <button class="modal-close" onclick="closeGenerateModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-notice">
        <div class="modal-notice-dot"></div>
        Each share code is deleted every 24 hours
      </div>
      <div class="code-display">
        <div class="code-display-value" id="gen-code-display">——————</div>
        <div class="code-display-sub" id="gen-code-sub">click generate to create your code</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" onclick="closeGenerateModal()">Cancel</button>
        <button class="modal-btn" id="copy-code-btn" onclick="copyShareCode()" style="display:none">Copy Code</button>
        <button class="modal-btn accent" id="gen-btn" onclick="generateShareCode()">Generate</button>
      </div>
    </div>
  </div>
</div>

<!-- USE SHARE CODE MODAL -->
<div class="modal-backdrop" id="use-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Use Share Code</div>
      <button class="modal-close" onclick="closeUseModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-notice">
        <div class="modal-notice-dot"></div>
        Each share code is deleted every 24 hours
      </div>
      <div class="code-input-row">
        <input class="code-input" id="code-input" maxlength="6" placeholder="Enter 6-char code" autocomplete="off" spellcheck="false">
        <button class="modal-btn accent" onclick="submitShareCode()" style="flex:0;white-space:nowrap;padding:9px 18px">Open</button>
      </div>
      <div class="code-status" id="code-status"></div>
    </div>
  </div>
</div>

<!-- SHARED PREVIEW MODAL -->
<div class="modal-backdrop" id="shared-preview-modal">
  <div class="modal preview-modal">
    <div class="modal-header" style="padding:14px 16px 0">
      <div class="modal-title" style="font-size:14px">Shared Preview</div>
      <button class="modal-close" onclick="closeSharedPreview()">×</button>
    </div>
    <div class="modal-body">
      <iframe class="shared-iframe" id="shared-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
      <div class="preview-modal-bar">
        <span class="shared-code-badge" id="shared-code-badge">——————</span>
        <div class="shared-expiry">
          <div class="modal-notice-dot" style="background:#facc15"></div>
          <span>Expires in 24 hours</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════
   JSONBIN SHARE SYSTEM
   ───────────────────────────────────────────────────
   SETUP (one time):
   1. Go to https://jsonbin.io and create a free account
   2. Go to API Keys → Create Access Key
   3. Paste your key below as JSONBIN_API_KEY
   4. That's it — no server needed
   ═══════════════════════════════════════════════════ */

  const JSONBIN_API_KEY = 'YOUR_JSONBIN_API_KEY_HERE'; // ← paste your key
  const JSONBIN_BASE    = 'https://api.jsonbin.io/v3';

  // The "index" bin holds a map of { shareCode: binId }
  // so we can look up a code → bin without scanning everything.
  // Create ONE bin manually on JSONBin and paste its ID below.
  // Contents should start as: {}
  const INDEX_BIN_ID = 'YOUR_INDEX_BIN_ID_HERE'; // ← paste your index bin ID

  const HEADERS = {
    'Content-Type': 'application/json',
    'X-Master-Key': JSONBIN_API_KEY,
    'X-Bin-Versioning': 'false'
  };

  /* ── Helpers ── */
  function genCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no ambiguous O/0/1/I
    return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  async function getIndex() {
    const r = await fetch(`${JSONBIN_BASE}/b/${INDEX_BIN_ID}/latest`, { headers: HEADERS });
    if (!r.ok) {
      const errText = await r.text();
      throw new Error(`Index read ${r.status}: ${errText}`);
    }
    const j = await r.json();
    return j.record || {};
  }

  async function setIndex(data) {
    await fetch(`${JSONBIN_BASE}/b/${INDEX_BIN_ID}`, {
      method: 'PUT',
      headers: HEADERS,
      body: JSON.stringify(data)
    });
  }

  async function purgeExpired(index) {
    // Remove entries older than 24h from the index (best-effort, client-side)
    const now = Date.now();
    let changed = false;
    for (const [code, entry] of Object.entries(index)) {
      if (now - entry.ts > 86400000) {
        // Optionally delete the bin too (fire-and-forget)
        fetch(`${JSONBIN_BASE}/b/${entry.binId}`, { method: 'DELETE', headers: HEADERS }).catch(() => {});
        delete index[code];
        changed = true;
      }
    }
    if (changed) setIndex(index).catch(() => {});
    return index;
  }

  /* ── GENERATE ── */
  let currentShareCode = null;

  function openGenerateCode() {
    document.getElementById('generate-modal').classList.add('visible');
    document.getElementById('gen-code-display').innerHTML = '——————';
    document.getElementById('gen-code-sub').textContent = 'click generate to create your code';
    document.getElementById('gen-btn').textContent = 'Generate';
    document.getElementById('gen-btn').disabled = false;
    document.getElementById('copy-code-btn').style.display = 'none';
    currentShareCode = null;
  }

  function closeGenerateModal() {
    document.getElementById('generate-modal').classList.remove('visible');
  }

  async function generateShareCode() {
    const html = document.getElementById('editor').value.trim();
    if (!html) {
      document.getElementById('gen-code-sub').textContent = 'your editor is empty!';
      return;
    }

    const btn = document.getElementById('gen-btn');
    const display = document.getElementById('gen-code-display');
    const sub = document.getElementById('gen-code-sub');

    btn.disabled = true;
    btn.textContent = 'Saving…';
    display.innerHTML = '<div class="code-spinner"></div>';
    sub.textContent = 'uploading your HTML…';

    try {
      // 1. Create a new bin with the HTML content
      const binRes = await fetch(`${JSONBIN_BASE}/b`, {
        method: 'POST',
        headers: { ...HEADERS, 'X-Bin-Name': 'partials-share' },
        body: JSON.stringify({ html, ts: Date.now() })
      });
      if (!binRes.ok) {
        const errText = await binRes.text();
        throw new Error(`${binRes.status}: ${errText}`);
      }
      const binData = await binRes.json();
      const binId = binData.metadata.id;

      // 2. Generate a unique code and add to index
      let index = await getIndex();
      index = await purgeExpired(index);

      let code = genCode();
      let attempts = 0;
      while (index[code] && attempts < 10) { code = genCode(); attempts++; }

      index[code] = { binId, ts: Date.now() };
      await setIndex(index);

      // 3. Show the code
      currentShareCode = code;
      display.textContent = code;
      display.style.letterSpacing = '10px';
      sub.textContent = 'share this code — it expires in 24 hours';
      btn.textContent = 'Regenerate';
      btn.disabled = false;
      document.getElementById('copy-code-btn').style.display = 'block';

    } catch (err) {
      console.error('generateShareCode error:', err);
      display.innerHTML = '<span style="font-size:14px;letter-spacing:0;color:#f87171">Failed</span>';
      sub.textContent = err.message || 'unknown error';
      btn.textContent = 'Try Again';
      btn.disabled = false;
    }
  }

  function copyShareCode() {
    if (!currentShareCode) return;
    navigator.clipboard.writeText(currentShareCode).then(() => {
      const btn = document.getElementById('copy-code-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy Code'; }, 1800);
    });
  }

  /* ── USE CODE ── */
  function openUseCode() {
    document.getElementById('use-modal').classList.add('visible');
    document.getElementById('code-input').value = '';
    document.getElementById('code-status').textContent = '';
    document.getElementById('code-status').className = 'code-status';
    document.getElementById('code-input').classList.remove('error');
    setTimeout(() => document.getElementById('code-input').focus(), 100);
  }

  function closeUseModal() {
    document.getElementById('use-modal').classList.remove('visible');
  }

  // Allow Enter key to submit
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('code-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitShareCode();
    });
    // Auto uppercase
    document.getElementById('code-input').addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
  });

  async function submitShareCode() {
    const raw = document.getElementById('code-input').value.trim().toUpperCase();
    const statusEl = document.getElementById('code-status');
    const input = document.getElementById('code-input');

    if (raw.length !== 6) {
      input.classList.add('error');
      statusEl.textContent = 'Code must be exactly 6 characters.';
      statusEl.className = 'code-status error';
      setTimeout(() => input.classList.remove('error'), 400);
      return;
    }

    statusEl.textContent = 'Looking up code…';
    statusEl.className = 'code-status loading';

    try {
      let index = await getIndex();
      index = await purgeExpired(index);

      const entry = index[raw];
      if (!entry) {
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 400);
        statusEl.textContent = 'Code not found or has expired.';
        statusEl.className = 'code-status error';
        return;
      }

      // Check 24h expiry client-side too
      if (Date.now() - entry.ts > 86400000) {
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 400);
        statusEl.textContent = 'This code has expired.';
        statusEl.className = 'code-status error';
        return;
      }

      // Fetch the bin content
      statusEl.textContent = 'Loading preview…';
      const binRes = await fetch(`${JSONBIN_BASE}/b/${entry.binId}/latest`, { headers: HEADERS });
      if (!binRes.ok) throw new Error('Bin not found');
      const binData = await binRes.json();
      const sharedHtml = binData.record.html;

      // Show in preview modal
      closeUseModal();
      document.getElementById('shared-code-badge').textContent = raw;
      document.getElementById('shared-iframe').srcdoc = sharedHtml;
      document.getElementById('shared-preview-modal').classList.add('visible');
      statusEl.textContent = '';

    } catch (err) {
      statusEl.textContent = 'Error fetching preview. Try again.';
      statusEl.className = 'code-status error';
    }
  }

  function closeSharedPreview() {
    document.getElementById('shared-preview-modal').classList.remove('visible');
    document.getElementById('shared-iframe').srcdoc = '';
  }

  // Close modals on backdrop click
  ['generate-modal', 'use-modal', 'shared-preview-modal'].forEach(id => {
    document.getElementById(id).addEventListener('mousedown', function(e) {
      if (e.target === this) {
        this.classList.remove('visible');
        if (id === 'shared-preview-modal') document.getElementById('shared-iframe').srcdoc = '';
      }
    });
  });

  // Escape closes all modals
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      ['generate-modal', 'use-modal', 'shared-preview-modal'].forEach(id => {
        document.getElementById(id).classList.remove('visible');
      });
      document.getElementById('shared-iframe').srcdoc = '';
    }
  });
</script>
</body>
</html>  }

  body { -webkit-user-select: none; user-select: none; }
  #editor { -webkit-user-select: text !important; user-select: text !important; }

  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    height: 48px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--text);
    flex-shrink: 0;
  }

  .nav-logo {
    width: 24px; height: 24px;
    border-radius: 5px;
    overflow: hidden;
    background: var(--surface2);
    display: grid;
    place-items: center;
    flex-shrink: 0;
  }

  .nav-logo img {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }

  .nav-logo .fallback {
    font-family: var(--serif);
    font-size: 11px;
    font-weight: 200;
    color: var(--accent);
  }

  .nav-title {
    font-family: var(--serif);
    font-weight: 200;
    font-size: 15px;
    letter-spacing: -0.3px;
  }

  .nav-version {
    font-size: 10px;
    color: var(--text-muted);
    background: var(--tag);
    padding: 2px 7px;
    border-radius: 20px;
    margin-left: 6px;
    letter-spacing: 0.3px;
    border: 1px solid var(--border);
  }

  .nav-divider {
    width: 1px; height: 20px;
    background: var(--border);
    margin: 0 16px;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 2px;
    flex: 1;
  }

  .nav-link {
    text-decoration: none;
    color: var(--text-muted);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    transition: color 0.15s, background 0.15s;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    border: none;
    background: none;
  }

  .nav-link:hover { color: var(--text); background: var(--surface2); }

  .dropdown { position: relative; }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 168px;
    box-shadow: 0 12px 36px rgba(0,0,0,0.6);
    z-index: 200;
  }

  .dropdown-menu.open { display: block; }

  .dropdown-item {
    display: block;
    text-decoration: none;
    color: var(--text-muted);
    padding: 7px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    transition: all 0.12s;
  }

  .dropdown-item:hover { color: var(--text); background: var(--surface2); }

  .dropdown-label {
    font-size: 10px;
    color: var(--text-dim);
    padding: 5px 12px 3px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
  }

  .github-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    color: var(--text-muted);
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--mono);
    border: 1px solid var(--border);
    transition: all 0.15s;
  }

  .github-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }
  .github-icon { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }

  /* TOOLBAR */
  .toolbar {
    position: fixed;
    top: 48px; left: 0; right: 0;
    z-index: 90;
    height: 42px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 6px;
  }

  .toolbar-label {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-right: 4px;
  }

  .view-toggle {
    display: flex;
    background: var(--bg);
    border-radius: 7px;
    padding: 3px;
    gap: 2px;
    border: 1px solid var(--border);
  }

  .view-btn {
    padding: 4px 12px;
    border-radius: 5px;
    border: none;
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .view-btn.active {
    background: var(--surface2);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.5);
  }

  .toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 8px; }

  .run-btn {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 16px;
    border-radius: 7px;
    border: none;
    background: var(--accent);
    color: #061208;
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    margin-left: auto;
    font-weight: 400;
  }

  .run-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(74,222,128,0.2); }

  .run-icon {
    width: 0; height: 0;
    border-left: 7px solid currentColor;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .clear-btn {
    padding: 5px 12px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .clear-btn:hover { border-color: var(--border-strong); color: var(--text); background: var(--surface2); }

  /* APP */
  .app {
    position: fixed;
    top: 90px; left: 0; right: 0; bottom: 24px;
    display: flex;
  }

  .editor-pane {
    width: 50%;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    position: relative;
    min-width: 0;
  }

  .pane-header {
    padding: 9px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    flex-shrink: 0;
  }

  .pane-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); opacity: 0.6; }

  .pane-title {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .line-count { margin-left: auto; font-size: 10px; color: var(--text-dim); }

  .editor-wrap {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .line-numbers {
    padding: 14px 10px 14px 0;
    width: 44px;
    text-align: right;
    color: var(--text-dim);
    font-size: 12px;
    line-height: 1.7;
    border-right: 1px solid var(--border);
    background: var(--bg);
    overflow: hidden;
    flex-shrink: 0;
    user-select: none !important;
    -webkit-user-select: none !important;
  }

  #editor {
    flex: 1;
    padding: 14px 16px;
    border: none;
    outline: none;
    resize: none;
    background: var(--surface);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12.5px;
    line-height: 1.7;
    tab-size: 2;
    white-space: pre;
    overflow-wrap: normal;
    overflow: auto;
    caret-color: var(--accent);
  }

  #editor::placeholder { color: var(--text-dim); }
  #editor:focus { background: #17171c; }

  .preview-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  #preview {
    flex: 1;
    border: none;
    background: white;
  }

  /* RESIZE HANDLE — fixed */
  .resize-handle {
    position: absolute;
    top: 0; right: -4px; bottom: 0;
    width: 8px;
    cursor: col-resize;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .resize-handle::after {
    content: '';
    width: 2px;
    height: 36px;
    border-radius: 2px;
    background: var(--border);
    transition: background 0.15s, height 0.15s;
  }

  .resize-handle:hover::after { background: var(--accent); height: 52px; }
  .resize-dragging .resize-handle::after { background: var(--accent); height: 52px; }

  /* VIEW MODES */
  .app.editor-only .preview-pane { display: none; }
  .app.editor-only .editor-pane { width: 100% !important; }
  .app.preview-only .editor-pane { display: none; }
  .app.preview-only .preview-pane { display: flex; width: 100%; }

  /* STATUS BAR */
  .status-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 24px;
    background: #0a0a0c;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
    z-index: 100;
  }

  .status-item {
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 5px;
    letter-spacing: 0.3px;
  }

  .status-item.live { color: var(--accent); opacity: 0.8; }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }
  .status-item.live .status-dot { animation: pulse 2s ease-in-out infinite; }

  /* CONTEXT MENU */
  #ctx-menu, #preview-ctx-menu {
    position: fixed;
    z-index: 9999;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 6px;
    min-width: 196px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04) inset;
    display: none;
    pointer-events: all;
  }

  #ctx-menu.visible, #preview-ctx-menu.visible {
    display: block;
    animation: ctxIn 0.12s cubic-bezier(0.2,0,0,1);
  }

  @keyframes ctxIn {
    from { opacity: 0; transform: scale(0.94) translateY(-6px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .ctx-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 7px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.1s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .ctx-item:hover { color: var(--text); background: var(--surface2); }
  .ctx-item.green:hover { color: var(--accent); background: var(--accent-dim); }

  .ctx-icon { width: 14px; height: 14px; opacity: 0.6; flex-shrink: 0; }

  .ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }

  .ctx-kbd {
    margin-left: auto;
    font-size: 10px;
    color: var(--text-dim);
    background: var(--bg);
    padding: 2px 5px;
    border-radius: 4px;
    border: 1px solid var(--border);
    white-space: nowrap;
  }

  /* FIX OVERLAY */
  .fix-overlay {
    position: absolute;
    inset: 0;
    background: rgba(14,14,16,0.88);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
    gap: 10px;
    flex-direction: column;
    backdrop-filter: blur(6px);
  }

  .fix-overlay.visible { display: flex; }
  .fix-msg { font-size: 12px; color: var(--text-muted); }
  .fix-spinner {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeSlideIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

  nav { animation: fadeSlideIn 0.35s ease both; }
  .toolbar { animation: fadeSlideIn 0.35s ease 0.05s both; }
  .app { animation: fadeSlideIn 0.35s ease 0.1s both; }

  /* ── SHARE BUTTONS IN TOOLBAR ── */
  .share-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .share-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 11px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .share-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }
  .share-btn.primary { background: var(--accent-dim); border-color: rgba(74,222,128,0.25); color: var(--accent); }
  .share-btn.primary:hover { background: rgba(74,222,128,0.15); border-color: rgba(74,222,128,0.4); }

  /* ── MODAL BACKDROP ── */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }

  .modal-backdrop.visible { display: flex; animation: backdropIn 0.2s ease; }

  @keyframes backdropIn { from{opacity:0} to{opacity:1} }

  /* ── MODAL BOX ── */
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    width: 420px;
    max-width: calc(100vw - 32px);
    box-shadow: 0 24px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.04) inset;
    animation: modalIn 0.22s cubic-bezier(0.2,0,0,1);
    overflow: hidden;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.94) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    padding: 20px 20px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .modal-title {
    font-family: var(--serif);
    font-weight: 200;
    font-size: 18px;
    letter-spacing: -0.3px;
    color: var(--text);
    line-height: 1.2;
  }

  .modal-close {
    width: 28px; height: 28px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: none;
    color: var(--text-muted);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.12s;
    line-height: 1;
  }

  .modal-close:hover { color: var(--text); background: var(--surface2); }

  .modal-body { padding: 16px 20px 20px; }

  .modal-notice {
    font-size: 10px;
    color: var(--text-dim);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 8px 12px;
    margin-bottom: 16px;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .modal-notice-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #facc15;
    flex-shrink: 0;
    animation: pulse 2s ease-in-out infinite;
  }

  /* ── GENERATED CODE DISPLAY ── */
  .code-display {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin-bottom: 14px;
    position: relative;
  }

  .code-display-value {
    font-family: var(--mono);
    font-size: 32px;
    letter-spacing: 10px;
    color: var(--accent);
    font-weight: 300;
    margin-bottom: 6px;
    min-height: 46px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .code-display-sub {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  .code-spinner {
    width: 22px; height: 22px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 0 auto 6px;
  }

  /* ── MODAL ACTIONS ── */
  .modal-actions {
    display: flex;
    gap: 8px;
  }

  .modal-btn {
    flex: 1;
    padding: 9px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: none;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .modal-btn:hover { color: var(--text); background: var(--surface2); border-color: var(--border-strong); }

  .modal-btn.accent {
    background: var(--accent);
    border-color: var(--accent);
    color: #061208;
    font-weight: 400;
  }

  .modal-btn.accent:hover { filter: brightness(1.08); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(74,222,128,0.2); }
  .modal-btn.accent:disabled { opacity: 0.4; cursor: not-allowed; transform: none; filter: none; }

  /* ── USE CODE INPUT ROW ── */
  .code-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
  }

  .code-input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 16px;
    letter-spacing: 4px;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.15s;
    text-align: center;
  }

  .code-input:focus { border-color: var(--accent); }
  .code-input.error { border-color: #f87171; animation: shake 0.35s ease; }
  .code-input::placeholder { letter-spacing: 2px; font-size: 12px; color: var(--text-dim); text-transform: none; }

  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-6px)}
    40%{transform:translateX(6px)}
    60%{transform:translateX(-4px)}
    80%{transform:translateX(4px)}
  }

  .code-status {
    font-size: 11px;
    margin-top: 8px;
    min-height: 16px;
    text-align: center;
  }

  .code-status.error { color: #f87171; }
  .code-status.success { color: var(--accent); }
  .code-status.loading { color: var(--text-muted); }

  /* ── SHARED PREVIEW MODAL ── */
  .preview-modal {
    width: min(900px, calc(100vw - 32px));
    height: min(600px, calc(100vh - 80px));
    display: flex;
    flex-direction: column;
  }

  .preview-modal .modal-body {
    flex: 1;
    padding: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-radius: 0 0 14px 14px;
  }

  .shared-iframe {
    flex: 1;
    border: none;
    background: white;
    border-radius: 0 0 14px 14px;
  }

  .preview-modal-bar {
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    flex-shrink: 0;
  }

  .shared-code-badge {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: var(--mono);
  }

  .shared-expiry {
    font-size: 10px;
    color: var(--text-dim);
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  @media (max-width: 640px) {
    .nav-links, .nav-divider { display: none; }
    .editor-pane { width: 100% !important; }
    .preview-pane { display: none; }
    .app.preview-only .editor-pane { display: none; }
    .app.preview-only .preview-pane { display: flex; width: 100%; }
  }
</style>
</head>
<body>

<nav>
  <a href="https://example.com" class="nav-brand">
    <div class="nav-logo" id="nav-logo-wrap">
      <img src="images/icon.png" alt="Partials" id="nav-icon" onerror="document.getElementById('nav-icon').style.display='none';document.getElementById('nav-fallback').style.display='block'">
      <span class="fallback" id="nav-fallback" style="display:none">P</span>
    </div>
    <span class="nav-title">Partials</span>
    <span class="nav-version">v1.2</span>
  </a>

  <div class="nav-divider"></div>

  <div class="nav-links">
    <a href="https://example.com" class="nav-link">About</a>

    <div class="dropdown">
      <button class="nav-link">Tools <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="opacity:0.4"><path d="M1 1l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <div class="dropdown-menu">
        <div class="dropdown-label">Tools</div>
        <a href="https://example.com" class="dropdown-item">Calculator</a>
        <a href="https://example.com" class="dropdown-item">Partials AI</a>
        <a href="https://example.com" class="dropdown-item">Chat Bubble</a>
      </div>
    </div>

    <a href="https://example.com" class="nav-link">Games</a>

    <div class="dropdown">
      <button class="nav-link">Templates <svg width="8" height="5" viewBox="0 0 8 5" fill="none" style="opacity:0.4"><path d="M1 1l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <div class="dropdown-menu">
        <div class="dropdown-label">Templates</div>
        <a href="https://example.com" class="dropdown-item">AI Template</a>
        <a href="https://example.com" class="dropdown-item">Calculator Template</a>
        <a href="https://example.com" class="dropdown-item">Portfolio Template</a>
      </div>
    </div>

    <a href="https://example.com" class="nav-link">Portfolio</a>
  </div>

  <div class="nav-right">
    <a href="https://github.com/partials-gh" target="_blank" class="github-btn">
      <svg class="github-icon" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      GitHub
    </a>
  </div>
</nav>

<div class="toolbar">
  <span class="toolbar-label">View</span>
  <div class="view-toggle">
    <button class="view-btn" id="btn-editor" onclick="setView('editor')">Editor</button>
    <button class="view-btn active" id="btn-split" onclick="setView('split')">Split</button>
    <button class="view-btn" id="btn-preview" onclick="setView('preview')">Preview</button>
  </div>
  <div class="toolbar-sep"></div>
  <button class="clear-btn" onclick="clearEditor()">Clear</button>

  <div class="share-group" style="margin-left:auto">
    <button class="share-btn" onclick="openUseCode()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      Use Share Code
    </button>
    <button class="share-btn primary" onclick="openGenerateCode()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
      Generate Share Code
    </button>
    <button class="run-btn" onclick="runPreview()">
      <span class="run-icon"></span>
      Run
    </button>
  </div>
</div>

<div class="app" id="app">
  <div class="editor-pane" id="editor-pane">
    <div class="pane-header">
      <div class="pane-dot"></div>
      <span class="pane-title">HTML Source</span>
      <span class="line-count" id="line-count">2 lines</span>
    </div>
    <div class="editor-wrap">
      <div class="line-numbers" id="line-numbers">1<br>2</div>
      <textarea id="editor" spellcheck="false" placeholder="Write HTML here…"><h1>Welcome</h1>
<p>Start building something.</p></textarea>
    </div>
    <div class="fix-overlay" id="fix-overlay">
      <div class="fix-spinner"></div>
      <span class="fix-msg">Fixing code…</span>
    </div>
    <div class="resize-handle" id="resize-handle"></div>
  </div>

  <div class="preview-pane" id="preview-pane">
    <div class="pane-header">
      <div class="pane-dot" style="background:#a78bfa;opacity:0.6"></div>
      <span class="pane-title">Preview</span>
    </div>
    <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

<div class="status-bar">
  <div class="status-item live">
    <div class="status-dot"></div>
    <span>Live</span>
  </div>
  <div class="status-item"><span>Partials HTML Previewer</span></div>
  <div class="status-item" style="margin-left:auto"><span id="char-count">0 chars</span></div>
  <div class="status-item"><span>est. 2026</span></div>
</div>

<!-- PREVIEW RIGHT-CLICK MENU -->
<div id="preview-ctx-menu" role="menu">
  <button class="ctx-item" onclick="refreshPreview()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
    </svg>
    Refresh Preview
  </button>
  <button class="ctx-item" onclick="sharePreview()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
    </svg>
    <span id="share-label">Share Preview</span>
  </button>
  <div class="ctx-sep"></div>
  <button class="ctx-item" style="color:#f87171" onclick="closePreviewPane()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
    Close Preview
  </button>
</div>

<!-- EDITOR RIGHT-CLICK MENU -->
<div id="ctx-menu" role="menu">
  <button class="ctx-item green" onclick="fixCode()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
    </svg>
    Fix Code
    <span class="ctx-kbd">auto</span>
  </button>
  <button class="ctx-item" onclick="runPreview(); closeCtx()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Run Preview
    <span class="ctx-kbd">ctrl+↵</span>
  </button>
  <div class="ctx-sep"></div>
  <button class="ctx-item" onclick="copyHTML()">
    <svg class="ctx-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
    </svg>
    <span id="copy-label">Copy HTML</span>
    <span class="ctx-kbd">html</span>
  </button>
</div>

<script>
  /* ── BLOCK DEVTOOLS ── */
  document.addEventListener('contextmenu', e => { e.preventDefault(); showCtx(e.clientX, e.clientY); });

  document.addEventListener('keydown', e => {
    if (e.key === 'F12') { e.preventDefault(); return; }
    if (e.ctrlKey && e.shiftKey && ['I','J','C','K'].includes(e.key.toUpperCase())) { e.preventDefault(); return; }
    if (e.ctrlKey && e.key.toLowerCase() === 'u') { e.preventDefault(); return; }
  });

  /* devtools size probe */
  setInterval(() => {
    if (window.outerWidth - window.innerWidth > 200 || window.outerHeight - window.innerHeight > 200) {
      document.body.style.display = 'none';
      document.title = 'close devtools';
    } else {
      if (document.body.style.display === 'none') {
        document.body.style.display = '';
        document.title = 'Partials · HTML Previewer';
      }
    }
  }, 800);

  /* ── DROPDOWN HOVER (JS-based, gap-proof) ── */
  document.querySelectorAll('.dropdown').forEach(dd => {
    let closeTimer;
    const menu = dd.querySelector('.dropdown-menu');

    dd.addEventListener('mouseenter', () => {
      clearTimeout(closeTimer);
      // close all other open menus
      document.querySelectorAll('.dropdown-menu.open').forEach(m => { if (m !== menu) m.classList.remove('open'); });
      menu.classList.add('open');
    });

    dd.addEventListener('mouseleave', () => {
      closeTimer = setTimeout(() => menu.classList.remove('open'), 80);
    });

    menu.addEventListener('mouseenter', () => clearTimeout(closeTimer));
    menu.addEventListener('mouseleave', () => {
      closeTimer = setTimeout(() => menu.classList.remove('open'), 80);
    });
  });

  // Close dropdowns when clicking elsewhere
  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
    }
  });
  const ctxMenu = document.getElementById('ctx-menu');

  function showCtx(x, y) {
    ctxMenu.classList.add('visible');
    const w = 200, h = 140;
    ctxMenu.style.left = Math.min(x, window.innerWidth - w - 8) + 'px';
    ctxMenu.style.top  = Math.min(y, window.innerHeight - h - 8) + 'px';
  }

  function closeCtx() { ctxMenu.classList.remove('visible'); }

  document.addEventListener('mousedown', e => {
    if (!ctxMenu.contains(e.target)) closeCtx();
  });

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeCtx(); });

  /* ── COPY HTML ── */
  function copyHTML() {
    closeCtx();
    navigator.clipboard.writeText(editor.value).then(() => {
      const lbl = document.getElementById('copy-label');
      lbl.textContent = 'Copied!';
      setTimeout(() => { lbl.textContent = 'Copy HTML'; }, 1800);
    }).catch(() => {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = editor.value;
      ta.style.cssText = 'position:fixed;opacity:0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    });
  }

  /* ── FIX CODE ── */
  function fixCode() {
    closeCtx();
    const overlay = document.getElementById('fix-overlay');
    overlay.classList.add('visible');
    setTimeout(() => {
      try {
        const raw = editor.value.trim();
        const parser = new DOMParser();
        const parsed = parser.parseFromString(raw, 'text/html');
        let fixed;
        if (raw.toLowerCase().includes('<!doctype') || raw.toLowerCase().includes('<html')) {
          fixed = '<!DOCTYPE html>\n<html lang="en">\n<head>\n' + parsed.head.innerHTML.trim() + '\n</head>\n<body>\n' + parsed.body.innerHTML.trim() + '\n</body>\n</html>';
        } else {
          fixed = parsed.body.innerHTML.trim();
        }
        editor.value = fixed;
        runPreview();
        updateLineNumbers();
      } catch(err) { /* silent */ }
      overlay.classList.remove('visible');
    }, 900);
  }

  /* ── EDITOR ── */
  const editor     = document.getElementById('editor');
  const preview    = document.getElementById('preview');
  const lineNums   = document.getElementById('line-numbers');
  const lineCount  = document.getElementById('line-count');
  const charCount  = document.getElementById('char-count');
  const app        = document.getElementById('app');

  let debounceTimer;

  /* ── PREVIEW CONTEXT MENU ── */
  const previewCtxMenu = document.getElementById('preview-ctx-menu');

  function showPreviewCtx(x, y) {
    closeCtx();
    previewCtxMenu.classList.add('visible');
    const w = 200, h = 130;
    previewCtxMenu.style.left = Math.min(x, window.innerWidth - w - 8) + 'px';
    previewCtxMenu.style.top  = Math.min(y, window.innerHeight - h - 8) + 'px';
  }

  function closePreviewCtx() { previewCtxMenu.classList.remove('visible'); }

  // Listen for right-click messages posted from inside the iframe
  window.addEventListener('message', e => {
    if (e.data && e.data.type === 'preview-contextmenu') {
      showPreviewCtx(e.data.x, e.data.y);
    }
  });

  // Close preview menu on click outside
  document.addEventListener('mousedown', e => {
    if (!previewCtxMenu.contains(e.target)) closePreviewCtx();
  });

  function refreshPreview() {
    closePreviewCtx();
    runPreview();
  }

  function sharePreview() {
    closePreviewCtx();
    const blob = new Blob([editor.value], { type: 'text/html;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    navigator.clipboard.writeText(url).then(() => {
      const lbl = document.getElementById('share-label');
      lbl.textContent = 'Link Copied!';
      setTimeout(() => { lbl.textContent = 'Share Preview'; URL.revokeObjectURL(url); }, 2500);
    }).catch(() => {
      window.open(url, '_blank');
    });
  }

  function closePreviewPane() {
    closePreviewCtx();
    setView('editor');
  }

  /* Inject right-click blocker into the srcdoc so the iframe can't show native menu */
  const BLOCKER_SCRIPT = `<script>
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.parent.postMessage({ type: 'preview-contextmenu', x: e.clientX, y: e.clientY }, '*');
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12') e.preventDefault();
      if (e.ctrlKey && e.shiftKey && ['I','J','C','K'].includes(e.key.toUpperCase())) e.preventDefault();
    });
  <\/script>`;

  function runPreview() {
    const src = editor.value.trim();
    let injected;
    if (src.toLowerCase().includes('</body>')) {
      injected = src.replace(/<\/body>/i, BLOCKER_SCRIPT + '</body>');
    } else if (src.toLowerCase().includes('<body')) {
      injected = src + BLOCKER_SCRIPT;
    } else {
      // bare HTML snippet — wrap it
      injected = src + BLOCKER_SCRIPT;
    }
    preview.srcdoc = injected;
  }

  editor.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(runPreview, 280);
    updateLineNumbers();
  });

  editor.addEventListener('scroll', () => {
    lineNums.scrollTop = editor.scrollTop;
  });

  function updateLineNumbers() {
    const lines = editor.value.split('\n');
    lineCount.textContent = lines.length + (lines.length === 1 ? ' line' : ' lines');
    charCount.textContent = editor.value.length.toLocaleString() + ' chars';
    lineNums.innerHTML = lines.map((_,i) => i+1).join('<br>');
  }

  editor.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = editor.selectionStart, end = editor.selectionEnd;
      editor.value = editor.value.slice(0, s) + '  ' + editor.value.slice(end);
      editor.selectionStart = editor.selectionEnd = s + 2;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(runPreview, 280);
      updateLineNumbers();
    }
    if (e.ctrlKey && e.key === 'Enter') runPreview();
  });

  /* ── VIEW MODES ── */
  function setView(mode) {
    app.className = 'app';
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    if (mode === 'editor') {
      app.classList.add('editor-only');
      document.getElementById('btn-editor').classList.add('active');
    } else if (mode === 'preview') {
      app.classList.add('preview-only');
      document.getElementById('btn-preview').classList.add('active');
    } else {
      document.getElementById('btn-split').classList.add('active');
    }
  }

  function clearEditor() {
    if (!editor.value.trim()) return;
    if (confirm('Clear all content?')) {
      editor.value = '';
      runPreview();
      updateLineNumbers();
    }
  }

  /* ── RESIZE (FIXED) ──
     Key fix: disable pointer-events on everything except the overlay div
     so the mouse can't "escape" to the iframe or other elements.          */
  const handle     = document.getElementById('resize-handle');
  const editorPane = document.getElementById('editor-pane');
  let isResizing   = false;

  /* Overlay that captures all mouse events during drag */
  const dragOverlay = document.createElement('div');
  dragOverlay.style.cssText = 'position:fixed;inset:0;z-index:9000;cursor:col-resize;display:none';
  document.body.appendChild(dragOverlay);

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    isResizing = true;
    dragOverlay.style.display = 'block';
    handle.classList.add('dragging');
  });

  dragOverlay.addEventListener('mousemove', e => {
    if (!isResizing) return;
    const rect = app.getBoundingClientRect();
    const pct  = ((e.clientX - rect.left) / rect.width) * 100;
    editorPane.style.width = Math.max(20, Math.min(80, pct)) + '%';
  });

  dragOverlay.addEventListener('mouseup', () => {
    isResizing = false;
    dragOverlay.style.display = 'none';
    handle.classList.remove('dragging');
  });

  /* Safety: also catch mouseup on document in case cursor flew past overlay */
  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      dragOverlay.style.display = 'none';
      handle.classList.remove('dragging');
    }
  });

  /* ── INIT ── */
  updateLineNumbers();
  runPreview();
</script>

<!-- GENERATE SHARE CODE MODAL -->
<div class="modal-backdrop" id="generate-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Generate Share Code</div>
      <button class="modal-close" onclick="closeGenerateModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-notice">
        <div class="modal-notice-dot"></div>
        Each share code is deleted every 24 hours
      </div>
      <div class="code-display">
        <div class="code-display-value" id="gen-code-display">——————</div>
        <div class="code-display-sub" id="gen-code-sub">click generate to create your code</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" onclick="closeGenerateModal()">Cancel</button>
        <button class="modal-btn" id="copy-code-btn" onclick="copyShareCode()" style="display:none">Copy Code</button>
        <button class="modal-btn accent" id="gen-btn" onclick="generateShareCode()">Generate</button>
      </div>
    </div>
  </div>
</div>

<!-- USE SHARE CODE MODAL -->
<div class="modal-backdrop" id="use-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Use Share Code</div>
      <button class="modal-close" onclick="closeUseModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-notice">
        <div class="modal-notice-dot"></div>
        Each share code is deleted every 24 hours
      </div>
      <div class="code-input-row">
        <input class="code-input" id="code-input" maxlength="6" placeholder="Enter 6-char code" autocomplete="off" spellcheck="false">
        <button class="modal-btn accent" onclick="submitShareCode()" style="flex:0;white-space:nowrap;padding:9px 18px">Open</button>
      </div>
      <div class="code-status" id="code-status"></div>
    </div>
  </div>
</div>

<!-- SHARED PREVIEW MODAL -->
<div class="modal-backdrop" id="shared-preview-modal">
  <div class="modal preview-modal">
    <div class="modal-header" style="padding:14px 16px 0">
      <div class="modal-title" style="font-size:14px">Shared Preview</div>
      <button class="modal-close" onclick="closeSharedPreview()">×</button>
    </div>
    <div class="modal-body">
      <iframe class="shared-iframe" id="shared-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
      <div class="preview-modal-bar">
        <span class="shared-code-badge" id="shared-code-badge">——————</span>
        <div class="shared-expiry">
          <div class="modal-notice-dot" style="background:#facc15"></div>
          <span>Expires in 24 hours</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════
   JSONBIN SHARE SYSTEM
   ───────────────────────────────────────────────────
   SETUP (one time):
   1. Go to https://jsonbin.io and create a free account
   2. Go to API Keys → Create Access Key
   3. Paste your key below as JSONBIN_API_KEY
   4. That's it — no server needed
   ═══════════════════════════════════════════════════ */

  const JSONBIN_API_KEY = '$2a$10$L6zRnwgz3cMlJ3MY3EI.1.8ue1ooMJeYpnF.AtGTTzxN7NP3ApMMa'; // ← paste your key
  const JSONBIN_BASE    = 'https://api.jsonbin.io/v3';

  // The "index" bin holds a map of { shareCode: binId }
  // so we can look up a code → bin without scanning everything.
  // Create ONE bin manually on JSONBin and paste its ID below.
  // Contents should start as: {}
  const INDEX_BIN_ID = '69a22661d0ea881f40e04537 '; // ← paste your index bin ID

  const HEADERS = {
    'Content-Type': 'application/json',
    'X-Access-Key': JSONBIN_API_KEY,
    'X-Bin-Private': 'false'
  };

  /* ── Helpers ── */
  function genCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // no ambiguous O/0/1/I
    return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  async function getIndex() {
    const r = await fetch(`${JSONBIN_BASE}/b/${INDEX_BIN_ID}/latest`, { headers: HEADERS });
    if (!r.ok) throw new Error('Failed to read index');
    const j = await r.json();
    return j.record || {};
  }

  async function setIndex(data) {
    await fetch(`${JSONBIN_BASE}/b/${INDEX_BIN_ID}`, {
      method: 'PUT',
      headers: HEADERS,
      body: JSON.stringify(data)
    });
  }

  async function purgeExpired(index) {
    // Remove entries older than 24h from the index (best-effort, client-side)
    const now = Date.now();
    let changed = false;
    for (const [code, entry] of Object.entries(index)) {
      if (now - entry.ts > 86400000) {
        // Optionally delete the bin too (fire-and-forget)
        fetch(`${JSONBIN_BASE}/b/${entry.binId}`, { method: 'DELETE', headers: HEADERS }).catch(() => {});
        delete index[code];
        changed = true;
      }
    }
    if (changed) setIndex(index).catch(() => {});
    return index;
  }

  /* ── GENERATE ── */
  let currentShareCode = null;

  function openGenerateCode() {
    document.getElementById('generate-modal').classList.add('visible');
    document.getElementById('gen-code-display').innerHTML = '——————';
    document.getElementById('gen-code-sub').textContent = 'click generate to create your code';
    document.getElementById('gen-btn').textContent = 'Generate';
    document.getElementById('gen-btn').disabled = false;
    document.getElementById('copy-code-btn').style.display = 'none';
    currentShareCode = null;
  }

  function closeGenerateModal() {
    document.getElementById('generate-modal').classList.remove('visible');
  }

  async function generateShareCode() {
    const html = document.getElementById('editor').value.trim();
    if (!html) {
      document.getElementById('gen-code-sub').textContent = 'your editor is empty!';
      return;
    }

    const btn = document.getElementById('gen-btn');
    const display = document.getElementById('gen-code-display');
    const sub = document.getElementById('gen-code-sub');

    btn.disabled = true;
    btn.textContent = 'Saving…';
    display.innerHTML = '<div class="code-spinner"></div>';
    sub.textContent = 'uploading your HTML…';

    try {
      // 1. Create a new bin with the HTML content
      const binRes = await fetch(`${JSONBIN_BASE}/b`, {
        method: 'POST',
        headers: { ...HEADERS, 'X-Bin-Name': 'partials-share' },
        body: JSON.stringify({ html, ts: Date.now() })
      });
      if (!binRes.ok) throw new Error('Failed to create bin');
      const binData = await binRes.json();
      const binId = binData.metadata.id;

      // 2. Generate a unique code and add to index
      let index = await getIndex();
      index = await purgeExpired(index);

      let code = genCode();
      let attempts = 0;
      while (index[code] && attempts < 10) { code = genCode(); attempts++; }

      index[code] = { binId, ts: Date.now() };
      await setIndex(index);

      // 3. Show the code
      currentShareCode = code;
      display.textContent = code;
      display.style.letterSpacing = '10px';
      sub.textContent = 'share this code — it expires in 24 hours';
      btn.textContent = 'Regenerate';
      btn.disabled = false;
      document.getElementById('copy-code-btn').style.display = 'block';

    } catch (err) {
      display.textContent = 'Error';
      sub.textContent = 'something went wrong — check your API key';
      btn.textContent = 'Try Again';
      btn.disabled = false;
    }
  }

  function copyShareCode() {
    if (!currentShareCode) return;
    navigator.clipboard.writeText(currentShareCode).then(() => {
      const btn = document.getElementById('copy-code-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy Code'; }, 1800);
    });
  }

  /* ── USE CODE ── */
  function openUseCode() {
    document.getElementById('use-modal').classList.add('visible');
    document.getElementById('code-input').value = '';
    document.getElementById('code-status').textContent = '';
    document.getElementById('code-status').className = 'code-status';
    document.getElementById('code-input').classList.remove('error');
    setTimeout(() => document.getElementById('code-input').focus(), 100);
  }

  function closeUseModal() {
    document.getElementById('use-modal').classList.remove('visible');
  }

  // Allow Enter key to submit
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('code-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitShareCode();
    });
    // Auto uppercase
    document.getElementById('code-input').addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
  });

  async function submitShareCode() {
    const raw = document.getElementById('code-input').value.trim().toUpperCase();
    const statusEl = document.getElementById('code-status');
    const input = document.getElementById('code-input');

    if (raw.length !== 6) {
      input.classList.add('error');
      statusEl.textContent = 'Code must be exactly 6 characters.';
      statusEl.className = 'code-status error';
      setTimeout(() => input.classList.remove('error'), 400);
      return;
    }

    statusEl.textContent = 'Looking up code…';
    statusEl.className = 'code-status loading';

    try {
      let index = await getIndex();
      index = await purgeExpired(index);

      const entry = index[raw];
      if (!entry) {
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 400);
        statusEl.textContent = 'Code not found or has expired.';
        statusEl.className = 'code-status error';
        return;
      }

      // Check 24h expiry client-side too
      if (Date.now() - entry.ts > 86400000) {
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 400);
        statusEl.textContent = 'This code has expired.';
        statusEl.className = 'code-status error';
        return;
      }

      // Fetch the bin content
      statusEl.textContent = 'Loading preview…';
      const binRes = await fetch(`${JSONBIN_BASE}/b/${entry.binId}/latest`, { headers: HEADERS });
      if (!binRes.ok) throw new Error('Bin not found');
      const binData = await binRes.json();
      const sharedHtml = binData.record.html;

      // Show in preview modal
      closeUseModal();
      document.getElementById('shared-code-badge').textContent = raw;
      document.getElementById('shared-iframe').srcdoc = sharedHtml;
      document.getElementById('shared-preview-modal').classList.add('visible');
      statusEl.textContent = '';

    } catch (err) {
      statusEl.textContent = 'Error fetching preview. Try again.';
      statusEl.className = 'code-status error';
    }
  }

  function closeSharedPreview() {
    document.getElementById('shared-preview-modal').classList.remove('visible');
    document.getElementById('shared-iframe').srcdoc = '';
  }

  // Close modals on backdrop click
  ['generate-modal', 'use-modal', 'shared-preview-modal'].forEach(id => {
    document.getElementById(id).addEventListener('mousedown', function(e) {
      if (e.target === this) {
        this.classList.remove('visible');
        if (id === 'shared-preview-modal') document.getElementById('shared-iframe').srcdoc = '';
      }
    });
  });

  // Escape closes all modals
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      ['generate-modal', 'use-modal', 'shared-preview-modal'].forEach(id => {
        document.getElementById(id).classList.remove('visible');
      });
      document.getElementById('shared-iframe').srcdoc = '';
    }
  });
</script>
</body>
</html>
